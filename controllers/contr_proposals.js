var Web3 = require('web3');
const BigNumber = require('bignumber.js');
web3 = new Web3(new Web3.providers.WebsocketProvider('wss://node.ditcraft.io/ws') || new Web3.providers.WebsocketProvider('wss://dai-trace-ws.blockscout.com/ws'));

var coordinatorAddr = '0x1dc6f1edd14b0b5d24305a0cfb6d4f0a5de3b4f6';
var coordinatorABI = [{"constant":true,"inputs":[{"name":"_repository","type":"bytes32"},{"name":"_proposalID","type":"uint256"}],"name":"getKNWVoteIDFromProposalID","outputs":[{"name":"KNWVoteID","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[{"name":"_repository","type":"bytes32"}],"name":"getCurrentProposalID","outputs":[{"name":"currentProposalID","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"name":"_repository","type":"bytes32"},{"name":"_proposalID","type":"uint256"},{"name":"_voteOption","type":"uint256"},{"name":"_voteSalt","type":"uint256"}],"name":"openVoteOnProposal","outputs":[{"name":"","type":"bool"}],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[{"name":"","type":"address"}],"name":"isKYCValidator","outputs":[{"name":"","type":"bool"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[],"name":"MAX_VOTE_DURATION","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[{"name":"","type":"bytes32"}],"name":"repositories","outputs":[{"name":"name","type":"string"},{"name":"currentProposalID","type":"uint256"},{"name":"votingMajority","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"name":"_repository","type":"bytes32"},{"name":"_proposalID","type":"uint256"}],"name":"finalizeVote","outputs":[{"name":"","type":"bool"}],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[{"name":"_address","type":"address"}],"name":"revokeKYC","outputs":[{"name":"","type":"bool"}],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[{"name":"","type":"bytes32"},{"name":"","type":"uint256"}],"name":"proposalsOfRepository","outputs":[{"name":"KNWVoteID","type":"uint256"},{"name":"knowledgeLabel","type":"string"},{"name":"proposer","type":"address"},{"name":"isFinalized","type":"bool"},{"name":"proposalAccepted","type":"bool"},{"name":"individualStake","type":"uint256"},{"name":"totalStake","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[],"name":"MIN_VOTE_DURATION","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[{"name":"_repository","type":"bytes32"}],"name":"getVotingMajority","outputs":[{"name":"votingMajority","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[],"name":"MAX_OPEN_DURATION","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[{"name":"_repository","type":"bytes32"},{"name":"_proposalID","type":"uint256"}],"name":"getIndividualStake","outputs":[{"name":"individualStake","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"name":"_repository","type":"string"},{"name":"_label1","type":"string"},{"name":"_label2","type":"string"},{"name":"_label3","type":"string"},{"name":"_votingMajority","type":"uint256"}],"name":"initRepository","outputs":[{"name":"","type":"bool"}],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[],"name":"MIN_OPEN_DURATION","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"name":"_address","type":"address"}],"name":"removeKYCValidator","outputs":[{"name":"","type":"bool"}],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[{"name":"_repository","type":"bytes32"},{"name":"_proposalID","type":"uint256"}],"name":"proposalHasPassed","outputs":[{"name":"hasPassed","type":"bool"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"name":"_newManager","type":"address"}],"name":"replaceDitManager","outputs":[{"name":"","type":"bool"}],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[{"name":"_repository","type":"bytes32"},{"name":"_knowledgeLabelID","type":"uint256"}],"name":"getKnowledgeLabels","outputs":[{"name":"knowledgeLabel","type":"string"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[],"name":"KNWTokenAddress","outputs":[{"name":"","type":"address"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[],"name":"nextDitCoordinator","outputs":[{"name":"","type":"address"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"name":"_repository","type":"bytes32"},{"name":"_proposalID","type":"uint256"},{"name":"_voteHash","type":"bytes32"},{"name":"_numberOfKNW","type":"uint256"}],"name":"voteOnProposal","outputs":[{"name":"","type":"bool"}],"payable":true,"stateMutability":"payable","type":"function"},{"constant":false,"inputs":[{"name":"_repository","type":"bytes32"},{"name":"_knowledgeLabelIndex","type":"uint256"},{"name":"_numberOfKNW","type":"uint256"},{"name":"_voteCommitDuration","type":"uint256"},{"name":"_voteOpenDuration","type":"uint256"}],"name":"proposeCommit","outputs":[{"name":"proposalID","type":"uint256"}],"payable":true,"stateMutability":"payable","type":"function"},{"constant":true,"inputs":[],"name":"BURNING_METHOD","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[{"name":"","type":"address"}],"name":"passedKYC","outputs":[{"name":"","type":"bool"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"name":"_address","type":"address"}],"name":"addKYCValidator","outputs":[{"name":"","type":"bool"}],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[],"name":"lastDitCoordinator","outputs":[{"name":"","type":"address"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[{"name":"_repository","type":"bytes32"}],"name":"repositoryIsInitialized","outputs":[{"name":"","type":"bool"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"name":"_address","type":"address"}],"name":"upgradeContract","outputs":[{"name":"","type":"bool"}],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[],"name":"KNWVotingAddress","outputs":[{"name":"","type":"address"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"name":"_address","type":"address"}],"name":"passKYC","outputs":[{"name":"","type":"bool"}],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[],"name":"MINTING_METHOD","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"name":"_repository","type":"string"}],"name":"migrateRepository","outputs":[{"name":"","type":"bool"}],"payable":false,"stateMutability":"nonpayable","type":"function"},{"inputs":[{"name":"_KNWTokenAddress","type":"address"},{"name":"_KNWVotingAddress","type":"address"},{"name":"_lastDitCoordinator","type":"address"}],"payable":false,"stateMutability":"nonpayable","type":"constructor"},{"anonymous":false,"inputs":[{"indexed":true,"name":"repository","type":"bytes32"},{"indexed":true,"name":"who","type":"address"}],"name":"InitializeRepository","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"name":"repository","type":"bytes32"},{"indexed":true,"name":"proposal","type":"uint256"},{"indexed":true,"name":"who","type":"address"},{"indexed":false,"name":"label","type":"string"},{"indexed":false,"name":"numberOfKNW","type":"uint256"}],"name":"ProposeCommit","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"name":"repository","type":"bytes32"},{"indexed":true,"name":"proposal","type":"uint256"},{"indexed":true,"name":"who","type":"address"},{"indexed":false,"name":"label","type":"string"},{"indexed":false,"name":"stake","type":"uint256"},{"indexed":false,"name":"numberOfKNW","type":"uint256"},{"indexed":false,"name":"numberOfVotes","type":"uint256"}],"name":"CommitVote","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"name":"repository","type":"bytes32"},{"indexed":true,"name":"proposal","type":"uint256"},{"indexed":true,"name":"who","type":"address"},{"indexed":false,"name":"label","type":"string"},{"indexed":false,"name":"accept","type":"bool"},{"indexed":false,"name":"numberOfVotes","type":"uint256"}],"name":"OpenVote","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"name":"repository","type":"bytes32"},{"indexed":true,"name":"proposal","type":"uint256"},{"indexed":true,"name":"who","type":"address"},{"indexed":false,"name":"label","type":"string"},{"indexed":false,"name":"votedRight","type":"bool"},{"indexed":false,"name":"numberOfKNW","type":"uint256"}],"name":"FinalizeVote","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"name":"repository","type":"bytes32"},{"indexed":true,"name":"proposal","type":"uint256"},{"indexed":false,"name":"label","type":"string"},{"indexed":false,"name":"accepted","type":"bool"}],"name":"FinalizeProposal","type":"event"}];
var coordinatorContract = new web3.eth.Contract(coordinatorABI, coordinatorAddr);

var votingAddr = '0x74F9c8Eeb2F0665858efD038007BbcF08075994D';
var votingABI = [{"constant":true,"inputs":[],"name":"nextKNWVoting","outputs":[{"name":"","type":"address"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[{"name":"","type":"uint256"}],"name":"stakesOfVote","outputs":[{"name":"proposersStake","type":"uint256"},{"name":"proposersReward","type":"uint256"},{"name":"returnPool","type":"uint256"},{"name":"rewardPool","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"name":"_voteID","type":"uint256"},{"name":"_voteOption","type":"uint256"},{"name":"_address","type":"address"}],"name":"finalizeVote","outputs":[{"name":"reward","type":"uint256"},{"name":"winningSide","type":"bool"},{"name":"numberOfKNW","type":"uint256"}],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[{"name":"","type":"address"}],"name":"ditCoordinatorContracts","outputs":[{"name":"","type":"bool"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[{"name":"_voteID","type":"uint256"}],"name":"isPassed","outputs":[{"name":"passed","type":"bool"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[],"name":"currentVoteID","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[{"name":"","type":"uint256"}],"name":"votes","outputs":[{"name":"repository","type":"bytes32"},{"name":"knowledgeLabel","type":"string"},{"name":"commitEndDate","type":"uint256"},{"name":"openEndDate","type":"uint256"},{"name":"neededMajority","type":"uint256"},{"name":"winningPercentage","type":"uint256"},{"name":"votesFor","type":"uint256"},{"name":"votesAgainst","type":"uint256"},{"name":"votesUnrevealed","type":"uint256"},{"name":"participantsFor","type":"uint256"},{"name":"participantsAgainst","type":"uint256"},{"name":"participantsUnrevealed","type":"uint256"},{"name":"isResolved","type":"bool"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"name":"_repository","type":"bytes32"},{"name":"_address","type":"address"},{"name":"_knowledgeLabel","type":"string"},{"name":"_commitDuration","type":"uint256"},{"name":"_revealDuration","type":"uint256"},{"name":"_proposersStake","type":"uint256"},{"name":"_numberOfKNW","type":"uint256"}],"name":"startVote","outputs":[{"name":"voteID","type":"uint256"}],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[{"name":"_address","type":"address"},{"name":"_voteID","type":"uint256"}],"name":"didOpen","outputs":[{"name":"revealed","type":"bool"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[{"name":"_voteID","type":"uint256"}],"name":"voteExists","outputs":[{"name":"exists","type":"bool"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[{"name":"_address","type":"address"},{"name":"_voteID","type":"uint256"}],"name":"didCommit","outputs":[{"name":"committed","type":"bool"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"name":"_newRepository","type":"bytes32"},{"name":"_majority","type":"uint256"}],"name":"addNewRepository","outputs":[{"name":"success","type":"bool"}],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[],"name":"startingVoteID","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"name":"_voteID","type":"uint256"}],"name":"endVote","outputs":[{"name":"votePassed","type":"bool"}],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[{"name":"_address","type":"address"},{"name":"_voteID","type":"uint256"}],"name":"getUsedKNW","outputs":[{"name":"usedKNW","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"name":"_newManager","type":"address"}],"name":"replaceDitManager","outputs":[{"name":"success","type":"bool"}],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[],"name":"KNWTokenAddress","outputs":[{"name":"","type":"address"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"name":"_newDitCoordinatorAddress","type":"address"}],"name":"addDitCoordinator","outputs":[{"name":"success","type":"bool"}],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[{"name":"_voteID","type":"uint256"}],"name":"commitPeriodActive","outputs":[{"name":"active","type":"bool"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[{"name":"_voteID","type":"uint256"}],"name":"voteEnded","outputs":[{"name":"ended","type":"bool"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[{"name":"_voteID","type":"uint256"}],"name":"getGrossStake","outputs":[{"name":"grossStake","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[],"name":"BURNING_METHOD","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[{"name":"_voteID","type":"uint256"}],"name":"isResolved","outputs":[{"name":"resolved","type":"bool"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[{"name":"_address","type":"address"},{"name":"_voteID","type":"uint256"}],"name":"getAmountOfVotes","outputs":[{"name":"numberOfVotes","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"name":"_voteID","type":"uint256"},{"name":"_address","type":"address"},{"name":"_voteOption","type":"uint256"},{"name":"_salt","type":"uint256"}],"name":"openVote","outputs":[{"name":"success","type":"bool"}],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[{"name":"_voteID","type":"uint256"},{"name":"_address","type":"address"},{"name":"_secretHash","type":"bytes32"},{"name":"_numberOfKNW","type":"uint256"}],"name":"commitVote","outputs":[{"name":"numberOfVotes","type":"uint256"}],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[{"name":"_terminationDate","type":"uint256"}],"name":"isExpired","outputs":[{"name":"expired","type":"bool"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[{"name":"_voteID","type":"uint256"}],"name":"getNetStake","outputs":[{"name":"netStake","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[{"name":"_voteID","type":"uint256"}],"name":"openPeriodActive","outputs":[{"name":"active","type":"bool"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"name":"_address","type":"address"}],"name":"upgradeContract","outputs":[{"name":"success","type":"bool"}],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[],"name":"MINTING_METHOD","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[],"name":"lastKNWVoting","outputs":[{"name":"","type":"address"}],"payable":false,"stateMutability":"view","type":"function"},{"inputs":[{"name":"_KNWTokenAddress","type":"address"},{"name":"_lastKNWVoting","type":"address"}],"payable":false,"stateMutability":"nonpayable","type":"constructor"}];
var votingContract = new web3.eth.Contract(votingABI, votingAddr);

var controller = {
    getAllProposals: function(callback){
        var proposals = [];
        coordinatorContract.getPastEvents('ProposeCommit', {
            filter: {},
            fromBlock: 0,
            toBlock: 'latest'
        }, async function(error, events) {
            if(error){
                console.error(error);
            } else {
                for(var i = 0; i < events.length; i++){
                    var proposal = {
                        repository: events[i].returnValues.repository,
                        proposal: new BigNumber(events[i].returnValues.proposal._hex),
                        who: events[i].returnValues.who,
                        label: events[i].returnValues.label,
                        numberOfKNW: new BigNumber(events[i].returnValues.numberOfKNW._hex) / Math.pow(10, 18)
                    };
                    await coordinatorContract.methods.proposalsOfRepository(events[i].returnValues.repository, parseInt(events[i].returnValues.proposal._hex)).call().then(async function(result){
                        proposal.KNWVoteID = new BigNumber(result.KNWVoteID._hex);
                        proposal.isFinalized = result.isFinalized;
                        proposal.proposalAccepted = result.proposalAccepted;
                        proposal.individualStake = new BigNumber(result.individualStake._hex) / Math.pow(10, 18);
                        //proposal.totalStake = new BigNumber(result.totalStake._hex);
                        await votingContract.methods.votes(parseInt(result.KNWVoteID._hex)).call().then(async function(result){
                            proposal.commitEndDate = new BigNumber(result.commitEndDate._hex);
                            proposal.openEndDate = new BigNumber(result.openEndDate._hex);
                            proposal.neededMajority = new BigNumber(result.neededMajority._hex);
                            proposal.winningPercentage = new BigNumber(result.winningPercentage._hex);
                            proposal.votesFor = new BigNumber(result.votesFor._hex) / Math.pow(10, 18);
                            proposal.votesAgainst = new BigNumber(result.votesAgainst._hex) / Math.pow(10, 18);
                            proposal.votesUnrevealed = new BigNumber(result.votesUnrevealed._hex);
                            proposal.participantsFor = new BigNumber(result.participantsFor._hex);
                            proposal.participantsAgainst = new BigNumber(result.participantsAgainst._hex);
                            proposal.participantsUnrevealed = new BigNumber(result.participantsUnrevealed._hex);
                            proposal.isResolved = result.isResolved;
                            await coordinatorContract.methods.repositories(events[i].returnValues.repository).call().then(function(result){
                                proposal.repositoryName = result.name;
                                proposals.push(proposal);
                            });
                        });
                    });
                };
            }
            callback(proposals);
        });
    }
}

module.exports = controller;